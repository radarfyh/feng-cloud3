-- 创建一个普通表test
create table test(id int, name varchar(10))
--插入记录到普通表test
insert into test values(1, 'tom');
insert into test values(2, 'amy');
insert into test values(3, 'edison');
--查询普通表的记录
select * from test where id in(1,2);

--启用向量插件
CREATE EXTENSION IF NOT EXISTS vector;
--查询向量插件是否启用
SELECT * FROM pg_extension WHERE extname = 'vector';
--创建一个向量表
CREATE TABLE items (id serial PRIMARY KEY, embedding vector(3));
--插入向量表记录
INSERT INTO items (embedding) VALUES ('[1, 2, 3]');
INSERT INTO items (embedding) VALUES ('[4, 5, 6]');
--查询向量表所有记录
SELECT * FROM items;
--查询某向量最近邻居
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;
--查询某行最近邻居
SELECT * FROM items WHERE id != 1 ORDER BY embedding <-> (SELECT embedding FROM items WHERE id = 1) LIMIT 5;
--查询某距离内的记录
SELECT * FROM items WHERE embedding <-> '[3,1,2]' < 5;
--得到距离
SELECT embedding <-> '[3,1,2]' AS distance FROM items;
--返回邻近内积，<#> '[3,1,2]') * -1用于计算内积，内积越大表示向量方向越接近，越相似
SELECT (embedding <#> '[3,1,2]') * -1 AS inner_product FROM items;
--余弦相似度范围 [-1, 1]，值越大表示向量方向越接近，越相似
SELECT 1 - (embedding <=> '[3,1,2]') AS cosine_similarity FROM items;
--均值
SELECT AVG(embedding) FROM items;
--分组均值
SELECT id, AVG(embedding) FROM items GROUP BY id;
--HNSW索引，多层图，L2。速度-召回权衡：查询性能优于IVFFlat，构建时间较慢且占用更多内存。由于没有像IVFFlat那样的训练步骤，可以在表中没有数据的情况下创建索引。
CREATE INDEX ON items USING hnsw (embedding vector_l2_ops);
--HNSW索引，多层图，内积
CREATE INDEX ON items USING hnsw (embedding vector_ip_ops);
--HNSW索引，多层图，余弦
CREATE INDEX ON items USING hnsw (embedding vector_cosine_ops);
--HNSW索引，多层图，L1
CREATE INDEX ON items USING hnsw (embedding vector_l1_ops);
--HNSW索引，Hamming，执行报错：operator class "bit_hamming_ops" does not accept data type vector
CREATE INDEX ON items USING hnsw (embedding bit_hamming_ops);
--HNSW索引，Jaccard，执行报错：postgres operator class "bit_jaccard_ops" does not accept data type vector
CREATE INDEX ON items USING hnsw (embedding bit_jaccard_ops);
--ivfflat索引，L2
CREATE INDEX ON items USING ivfflat (embedding vector_l2_ops) WITH (lists = 100);
--ivfflat索引，内积
CREATE INDEX ON items USING ivfflat (embedding vector_ip_ops) WITH (lists = 100);
--ivfflat索引，余弦
CREATE INDEX ON items USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
--ivfflat索引，hamming，执行报错：operator class "bit_hamming_ops" does not accept data type vector
CREATE INDEX ON items USING ivfflat (embedding bit_hamming_ops) WITH (lists = 100);
--langchain4j
CREATE TABLE
  public.vector_items (
    embedding_id uuid NOT NULL,
    embedding vector (1024) NULL,
    text text NULL,
    metadata json NULL
  );

ALTER TABLE
  public.vector_items
ADD
  CONSTRAINT vector_items_pkey PRIMARY KEY (embedding_id)
--langchain4j查询实例
WITH temp AS (SELECT (2 - (embedding <=> '[-0.023411544, -0.009788666, -0.013115035, 0.05246014, 0.02694105, 0.020719977, -0.034533296, 0.10502185, 0.020694586, 0.015501895, -0.030572124, 0.043471325, 0.0057195774, -0.03326369, 0.015768513, -9.2998677E-4, 0.004507103, -3.1393003E-5, -0.035015747, 0.014587779, 0.040855937, -0.011985085, 0.007249453, 0.036412314, -0.010385381, 0.030724477, 0.054034453, 0.024935072, -0.025074728, -0.026864873, 0.023665465, 0.04875289, 0.021976888, 0.020288311, -0.023868602, 0.00664639, 0.069523655, -0.011674032, 0.022306986, -0.040932115, -0.009718838, -0.015121013, -0.017317433, 0.04722936, -0.047280148, -0.021278605, 0.04413152, -0.032349575, 0.004719762, -0.0406528, 0.025646051, 0.04253182, 0.036539275, 0.018282333, 0.025696835, 0.031079967, 0.04910838, -0.0031041878, 0.033111338, -0.034634866, 0.017317433, -0.007789036, 8.034229E-4, 0.02055493, 0.027271148, -0.010429817, -0.0047673723, 0.045096423, 0.0028804198, 0.12330418, -0.025214385, 0.0062909, 0.0135467015, 0.015209886, 0.029404087, -0.037351824, 0.030191243, 0.01100114, -0.01129315, 0.022789437, -0.013013466, -0.0024265354, 0.0014052957, 0.039154664, 0.026509384, -0.01693655, -0.02248473, -0.19369116, 0.01064565, -0.005735447, 0.030775262, -5.6190005E-5, -0.027702814, -0.03029281, -0.009826754, 0.051799946, -0.021659486, -0.017050816, -0.031410065, 0.031511635, -0.0143719455, -0.016784199, -0.009395088, -0.024135219, 0.063277185, 0.003313673, -0.00233925, 0.040602017, 0.03125771, -0.023309976, -0.0057640136, 0.0016631845, 0.0012973791, -0.037961233, -0.050987396, 0.024947768, -0.017799882, 0.032146435, 8.4408995E-5, -0.002940726, 0.0019075838, -0.021380173, -0.013013466, -0.038951527, -0.024465317, 0.003526332, -0.018828264, -0.005494222, -0.0036755109, -0.058858957, 0.0071478845, -0.0026201503, -0.0026804567, -0.003124819, 0.10299048, -0.02342424, 0.013026163, 0.06977757, 0.016669933, 0.012118394, -0.08242285, -0.023817819, 0.05068269, 0.009845798, -0.026839482, 0.018053804, 0.021786448, 0.041897014, -0.0040595667, 0.05926523, -0.046797697, -0.04103368, 0.028921636, 0.026331639, -0.0012426274, -0.05779249, 0.031867124, 0.039053097, -0.01377523, -0.029734185, 0.015578072, -0.0121755265, 0.004884811, 0.008544452, -0.069879144, -0.04372525, 0.068406396, 0.0041516135, -0.019526549, 0.06926973, -0.06855875, -0.019920126, 0.0028693108, 0.032374967, -0.053475827, 0.01051869, 0.015641551, 2.3170319E-4, 0.045705833, 0.012949986, -0.0046023238, 0.069472864, 0.043065052, 0.013115035, -0.038469076, -0.024757328, 0.066222675, -0.02106277, -0.020186743, -0.027398108, 0.013952975, 0.0050149458, 0.056370527, -0.008760285, 0.010988444, -0.02045336, -0.058046408, -0.027702814, -0.019831253, 0.0034311116, 0.039967213, -0.035853688, 0.005694185, -0.018612431, -0.026433207, -0.009420481, 0.0062242458, -0.002531278, 0.068254046, -0.037504178, -0.014283073, -0.011159841, -0.007928693, -0.034380943, -0.007249453, -0.0016933377, -0.036107607, 0.007814428, -0.004897507, -0.014816307, -0.005684663, -0.0072177127, -0.027321931, -7.9945533E-4, -0.06251542, 0.010505994, 0.047889557, 0.0069130072, 1.6792529E-4, 0.022802133, 0.0044372748, -0.045020245, 0.0053577395, -0.02497316, 0.023271887, 0.017888755, 0.0014291008, -0.03232418, -0.011572463, 0.081000894, -0.05004789, 0.03158781, -0.059062093, -0.074449725, 0.0028978768, -0.018701304, -0.0055799205, 0.036640845, 0.046899263, -0.0043230103, -0.048448183, -0.02151983, -0.035015747, 0.023119533, -0.004434101, 0.029937321, 0.053729746, -0.0028169395, -0.030394379, -0.021113556, 0.016250962, 0.06525777, -0.06688287, -0.0012918246, -0.017266648, -0.023716249, -0.007922345, 0.007960433, -0.039789468, 7.466873E-4, 0.004288096, 0.016720718, -0.038494468, 0.042277895, -0.014968661, -4.8443422E-4, -0.056776803, 0.005656097, -0.017101599, -0.004751502, -0.027956735, -0.013749838, 0.0063670767, -0.061906014, 0.013737142, -0.03943398, -0.003304151, 0.021557918, -0.017177776, -0.015247974, -0.034152415, -0.032755848, -0.020466058, -0.0066908263, 0.028642323, 0.08201658, 0.022306986, 0.006982836, -0.007109796, -0.0059861946, -0.068254046, -0.020199439, -0.0059354105, 0.012359619, 0.009363348, 0.016149394, 0.06414052, 0.0057989275, -0.03674241, -0.04255721, 0.016416011, -0.037224863, -0.032984376, -0.046213675, -0.070031494, -0.025087424, -0.0025693662, 0.008334966, -0.028109089, -0.0030518167, -0.025442915, -0.012594497, -0.103498325, 0.034482513, 0.036183786, 0.05306955, -0.036945548, 0.014232289, 0.0042182677, 0.009191951, -0.03509192, -0.040830545, -0.06210915, -0.043801423, -0.012302487, -0.057437, 0.011781949, -0.04019574, -0.043826815, -0.0030486425, -0.014968661, 0.006452775, 0.0059544547, -0.017507873, -0.008309575, -0.03242575, 0.098369114, -0.024592279, 0.020999292, 0.02752507, 6.074274E-4, -0.051114358, 0.029480264, 0.015705032, 0.06221072, -0.04436005, -0.019856645, -0.0030359465, 0.0049292473, -0.0014529059, -0.0015147992, -0.022954486, 0.008423839, 0.013724446, 0.041236818, -0.0063607288, 0.008715848, -0.0012537364, -0.0406528, 0.013064251, -0.02836301, 0.027982127, -0.008626976, 0.078817174, -0.023449631, -0.06094111, -0.004535669, 0.03862143, -0.008214354, 0.038900744, -0.03661545, -0.026433207, 0.0048245047, -0.008836461, -0.0069955317, 0.037986625, 0.05068269, -0.053831317, -0.010213984, -0.0133816525, -0.017888755, 0.0011370913, -0.05972229, 0.030089675, 0.00896977, 0.023132231, -0.009433176, 0.028312225, 0.03590447, -0.058401898, -0.0251636, -0.011572463, -0.04029731, -0.081153244, 0.014829004, -0.032146435, -0.013140427, -0.041160643, 0.01913297, 0.012988075, 0.018891744, -0.05007328, -0.0077001634, -0.0040087826, 0.037377216, 0.02991193, 0.018840961, -0.003900866, -0.054643862, -0.03984025, 0.011718468, 0.0351681, 0.0143719455, -0.0030026194, -0.04527417, 0.052561708, 0.0287185, 0.037301037, -0.0061353734, -0.069320515, -0.041668486, -0.029073989, -0.0012378664, 0.033212908, -0.013089643, -0.014118024, 0.09684558, 0.0044499706, -0.0041738315, 0.002537626, -0.015082926, -0.036945548, 0.029708792, -0.017761795, -0.07891874, -0.015286062, -0.014346553, -0.0062972484, -0.03003889, 0.03351761, -0.03562516, 0.032984376, -0.022802133, -0.018510863, -0.08201658, 0.026382422, -0.035752118, -0.017342824, -0.0030343595, -0.031460848, 0.03443173, 0.053374257, -0.009496656, 0.0011799405, 0.011991433, -0.016022434, -0.0351681, 0.045248777, 0.02562066, -0.04542652, 0.011147145, -0.058401898, 0.039738685, 0.03232418, -0.017482482, 0.050377987, -0.06307405, -0.06698444, -0.0061512436, -0.015895473, -0.02777899, 0.05733543, -0.02432566, 0.012416751, 0.040322702, 0.008722196, 0.040322702, 0.0073065856, 0.03100379, 0.023576593, 0.030826045, -0.021634094, -0.010702782, 0.014219592, -0.024820806, -0.041922405, -0.027220363, -0.020821547, -5.227208E-5, 0.04446162, 0.0203264, -0.023767034, -0.027118795, 0.049514655, 2.961754E-4, -0.013952975, 0.009414132, 0.022573603, -0.016949248, 0.02635703, -0.026077718, 0.007255801, 0.051292103, -0.008074697, 0.016682629, 0.031892516, -0.030851439, 0.018726695, -0.0067670024, -0.009655357, -0.03971329, 0.023589289, -0.03232418, -0.0066908263, 0.07043777, 0.01971699, 5.879865E-4, 0.021862624, -0.0028502666, -0.04019574, -0.03984025, 0.0073891096, 0.0049578133, 0.0612966, -0.016187483, -0.020402577, -0.048194263, 0.016504884, -0.03788506, -0.022891006, -0.021367477, -0.009725186, -0.014321161, 0.014206897, -0.009947367, 0.04303966, 0.029861145, -0.067289144, 0.0101441555, 0.019006008, 0.042150937, 0.043801423, 0.028921636, 0.028515361, 0.0015885951, -0.015603464, -0.021380173, 0.03384771, -0.04491868, 0.022560908, -0.0018948877, -0.013241996, 0.014968661, 0.01703812, -0.001977412, 0.005465656, -0.0049927277, 0.013851407, -0.052409355, -0.007236757, 0.007884257, -0.014511602, -0.046188284, -0.040246528, -0.0035771164, 0.024795415, 0.06815248, -0.03783427, -0.0046626297, -0.0057703615, 0.017952235, -0.047711812, 0.021596007, -5.816385E-4, -0.004332532, 0.0073510217, 0.03087683, -0.06779699, -0.019463068, 0.02091042, 0.04733093, 0.01122967, 0.012829374, 6.0504684E-5, 0.049057595, 0.005068904, 0.014168808, 0.008944377, 0.012226311, 0.016466796, 0.0115153305, 0.028896244, 0.01490518, -0.04027192, 0.0032533666, 0.038926136, 0.035929862, -0.009299868, 0.0031137099, 0.036920156, 0.049997102, -0.017571354, 0.02264978, 0.030318202, -0.0020694586, -0.011121753, 0.04055123, 0.011908909, -0.01058217, 0.002182136, 0.046645343, -0.06957444, 0.05865582, -0.022624388, 0.0038532557, 0.01877748, -0.04364907, 0.0068050907, 0.005395828, -0.004513451, -0.0024090784, -0.03991643, 0.015933562, -0.02777899, 0.03590447, 0.00987119, 0.04255721, -0.006255986, 0.035345845, -0.0055989646, 0.0071669286, 0.028236048, 0.019831253, -7.633509E-4, -0.0025884102, -0.03433016, -0.020605713, 0.032349575, 0.034863394, 0.03813898, 0.0094268285, 0.048575144, 0.04997171, 0.05116514, 0.026407816, -0.031410065, 0.016022434, 0.049006812, -0.004859419, -0.026153894, -0.016352532, -1.04841725E-4, 0.019120274, 0.0073446734, -0.013699054, 0.031206928, 0.013876799, -0.014473514, 0.019831253, 0.048194263, -0.0058878, -0.022319682, -0.02200228, -0.0051736464, 0.043496717, -0.003140689, -0.06789856, -0.026661737, -0.01200413, 0.005897322, -0.029124772, -0.008988814, 0.045858186, 0.026153894, -0.0034279376, -0.022078456, -0.031308495, 0.05626896, 0.01267702, -0.016111307, -0.020821547, 0.0203264, 0.048625927, 0.030165851, 0.015349543, 0.007636683, 0.0203264, -0.026331639, -0.014968661, -0.058147978, -0.020377183, -0.0049736835, -0.060737975, 0.0034120674, 0.046264462, 0.010823395, -0.0153622385, 9.109427E-4, -0.02248473, -0.008468275, -0.009280823, 0.008373055, -0.02122782, 0.046772305, -0.008950726, -0.02790595, 0.010175896, -0.07043777, -0.04062741, 0.02407174, -0.009928322, 0.057183076, -0.033111338, -0.01722856, 0.009852147, -0.03135928, 0.008811069, 0.032273397, 0.011540723, 6.6019536E-4, -0.0319433, 0.007947736, 0.039789468, 0.032349575, 0.004751502, 0.014321161, -0.03445712, 0.04212554, -0.036031432, -0.03361918, 0.10593597, -0.018561646, -0.029607223, 0.035498198, -8.046131E-4, -0.007376414, -0.03938319, 0.007630335, -0.018371206, 6.681304E-4, 0.010486949, -0.013457829, 0.0064972113, -0.03851986, -0.032273397, 0.07160581, -0.02790595, 0.011737512, -0.04146535, 0.043471325, -0.020821547, 0.011547071, 0.023500416, 0.03671702, 0.012638933, 0.024338357, 0.0038310376, -0.061448954, 0.019171057, 0.030013498, 0.006659086, 0.01680959, 0.018498167, -6.6455966E-4, 0.031867124, 0.0027931342, 0.005497396, 0.0025931713, 4.7530895E-4, 0.019374195, -0.011051925, -0.07231679, -0.019920126, -0.020999292, -0.005522788, 5.086361E-4, 0.011128101, -0.028032912, 0.04212554, 0.025988845, -0.0011442328, -0.02884546, 0.016923854, -0.0147020435, 0.017863363, 0.004897507, -0.012607193, 0.025607962, -0.03100379, -0.0027899602, 0.036894765, 0.002348772, 0.0127214575, 0.03316212, -0.011305846, 0.04364907, -0.0071351887, -0.0036342486, -0.03598065, 0.015438415, -0.006068719, -0.014283073, -0.010264768, 0.025138209, 0.013864103, 0.023500416, -0.0016084327, 6.673369E-4, -0.0014457644, -0.021151645, 0.037351824, -0.033314474, 0.02003439, 0.019805862, 0.018917136, -0.017685618, 0.07292619, 0.0042119194, 0.04329358, -0.046797697, -0.008690457, -0.008823765, -0.0055926167, 0.013076947, -0.015755817, 0.043496717, 0.010182244, 0.0028359834, 0.021367477, 0.0438776, -7.851723E-4, -0.055304058, -0.021596007, -0.019983606, -0.02836301, -0.0028486797, -0.037732705, 0.03971329, 0.0014552864, 0.042607993, 0.049184557, 0.054796215, 0.0070971004, 0.02122782, -0.02551909, -0.02187532, 0.019793166, 0.014778219, 0.0153622385, 0.028997812, -0.012346923, -0.039611723, -0.009991803, -0.061245818, 0.0097569255, -0.01739361, 0.005678315, -0.015501895, -0.035599764, 0.00896977, -0.050124064, -0.031130752, -0.0065575177, -0.019120274, -0.0034279376, 0.029861145, 0.033898495, -0.043445934, 0.009210995, 0.013127731, -0.02635703, 0.022408554, -0.07338326, -0.01364827, -0.012454839, -0.0011378848, -0.013216604, -2.2714054E-4, -0.014194201, -0.034634866, 0.0029565962, 0.0032660628, -0.0073573696, -0.039611723, 0.015413023, 0.01771101, -0.038215157, -0.023144927, -0.037656527, 0.02426218, -0.04017035, -0.04423309, -0.0012553234, -0.016758805, -0.01622557, -0.018764785, -0.02887085, 0.015539983, 0.023830514, 0.023030661, 0.009306216, 0.0053133033, 0.0067860465, -0.022891006, 0.003348587, 0.0148670925, -0.042354073, -0.00822705, 0.03994182, 0.013521309, -0.023132231, -0.0072621494, -0.00624329, 0.0092617795, 0.02442723, -0.04915916, -0.019577332, -0.014206897, -0.013419741, 0.047483284, -0.0193615, 0.0070971004, 0.0338731, 0.007896952, 0.0021757882, 0.005684663, -0.016174788, 0.005827494, -0.0016020847, -0.016124003, 0.021888016, -0.025315953, -0.0079985205, -0.037707314, -0.015070229, -0.004500755, -0.016885767, 0.042404857, -0.013343564, -0.028769283, -0.02068189, 0.017190471, 4.118286E-4, 0.0043737944, -0.014168808, 0.029150166, -0.063988164, 0.003542202, 0.012080306, -0.007439894, 0.028337616, 0.018561646, -0.0054275678, -0.021976888, -0.03504114, -0.016530277, -0.0338731, -0.025239777, -0.0012275508, 0.00896977, -0.009972759, 0.017558658, -0.018980617, -0.0011577224, 0.011064621, 0.010810699, -0.041770052, -0.009052294, 0.0031787772, 0.022624388, 0.047178578, 0.010239377, 0.0010212397, 0.02442723, 0.0045451913, -0.08739971, -0.0041357432, -0.022560908, 0.01752057, -0.004303966, 0.022446644, -0.017660227, 0.023030661, -0.03255271, -0.027398108, 0.027144186, 0.0036945548, -0.023221103, -0.017964931, -0.036564667, -0.038926136, 0.008334966, -0.03280663, 0.014803612, 0.011305846, -0.001252943, 0.033085946, 0.011966041, 0.0064242086, 0.021710271, 0.0126706725, -0.01335626, 0.046442207, -0.03933241, 0.030394379, 0.03280663, -0.03933241, 0.008112785, 0.020123264, 0.060788758, -0.01626366, -0.052663278, 0.0035485502, -0.0137117505]')) / 2 AS score, embedding_id, embedding, text, metadata FROM vector_items WHERE (metadata->>'knowledgeId')::int is not null and (metadata->>'knowledgeId')::int = 1) SELECT * FROM temp WHERE score >= 0.0 ORDER BY score desc LIMIT 3;

