package ltd.huntinginfo.feng.center.controller;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import ltd.huntinginfo.feng.center.api.dto.SystemLogQueryDTO;
import ltd.huntinginfo.feng.center.api.vo.*;
import ltd.huntinginfo.feng.center.service.UmpSystemLogService;
import ltd.huntinginfo.feng.common.core.util.R;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpHeaders;
import org.springframework.util.StringUtils;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;

/**
 * 系统日志表控制器
 * 提供系统日志的查询、统计和管理接口
 */
@Slf4j
@Validated
@RestController
@RequestMapping("/api/system/log")
@RequiredArgsConstructor
@Tag(name = "系统日志管理", description = "系统日志的查询、统计和管理")
public class UmpSystemLogController {

    private final UmpSystemLogService umpSystemLogService;

    @Operation(summary = "记录操作日志", description = "记录操作日志")
    @PostMapping("/record/operation")
    public R<String> recordOperationLog(
            @RequestParam(required = false) String logType,
            @RequestParam(required = false) String logLevel,
            @RequestParam(required = false) String appKey,
            @RequestParam(required = false) String operator,
            @RequestParam(required = false) String operation,
            @RequestParam(required = false) String requestId,
            @RequestParam(required = false) String apiPath,
            @RequestParam(required = false) String httpMethod,
            @RequestBody(required = false) Map<String, Object> requestParams,
            @RequestParam(required = false) String responseCode,
            @RequestParam(required = false) String responseMessage,
            @RequestBody(required = false) Map<String, Object> responseData,
            @RequestParam(required = false) String ipAddress,
            @RequestParam(required = false) String userAgent,
            @RequestParam(required = false) String serverHost,
            @RequestParam(required = false) Integer costTime,
            @RequestParam(required = false) Integer memoryUsage,
            @RequestParam(required = false) String errorMessage,
            @RequestParam(required = false) String errorStack) {
        try {
            String logId = umpSystemLogService.recordOperationLog(
                    logType, logLevel, appKey, operator, operation, requestId, apiPath, httpMethod,
                    requestParams, responseCode, responseMessage, responseData,
                    ipAddress, userAgent, serverHost, costTime, memoryUsage,
                    errorMessage, errorStack);
            return R.ok(logId, "操作日志记录成功");
        } catch (Exception e) {
            log.error("记录操作日志失败", e);
            return R.failed("操作日志记录失败: " + e.getMessage());
        }
    }

    @Operation(summary = "记录认证日志", description = "记录认证日志")
    @PostMapping("/record/auth")
    public R<String> recordAuthLog(
            @RequestParam(required = false) String logLevel,
            @RequestParam(required = false) String appKey,
            @RequestParam(required = false) String operator,
            @RequestParam(required = false) String requestId,
            @RequestParam(required = false) String apiPath,
            @RequestParam(required = false) String httpMethod,
            @RequestBody(required = false) Map<String, Object> requestParams,
            @RequestParam(required = false) String authType,
            @RequestParam(required = false) Integer authStatus,
            @RequestParam(required = false) String authErrorCode,
            @RequestParam(required = false) String ipAddress,
            @RequestParam(required = false) String userAgent,
            @RequestParam(required = false) String serverHost,
            @RequestParam(required = false) Integer costTime) {
        try {
            String logId = umpSystemLogService.recordAuthLog(
                    logLevel, appKey, operator, requestId, apiPath, httpMethod,
                    requestParams, authType, authStatus, authErrorCode,
                    ipAddress, userAgent, serverHost, costTime);
            return R.ok(logId, "认证日志记录成功");
        } catch (Exception e) {
            log.error("记录认证日志失败", e);
            return R.failed("认证日志记录失败: " + e.getMessage());
        }
    }

    @Operation(summary = "记录系统日志", description = "记录系统日志")
    @PostMapping("/record/system")
    public R<String> recordSystemLog(
            @RequestParam(required = false) String logLevel,
            @RequestParam(required = false) String operation,
            @RequestParam(required = false) String responseMessage,
            @RequestParam(required = false) String errorMessage,
            @RequestParam(required = false) String errorStack) {
        try {
            String logId = umpSystemLogService.recordSystemLog(
                    logLevel, operation, responseMessage, errorMessage, errorStack);
            return R.ok(logId, "系统日志记录成功");
        } catch (Exception e) {
            log.error("记录系统日志失败", e);
            return R.failed("系统日志记录失败: " + e.getMessage());
        }
    }

    @Operation(summary = "根据请求ID查询日志", description = "根据请求ID查询日志详情")
    @GetMapping("/request/{requestId}")
    public R<SystemLogDetailVO> getByRequestId(
            @Parameter(description = "请求ID", required = true) 
            @PathVariable String requestId) {
        SystemLogDetailVO log = umpSystemLogService.getByRequestId(requestId);
        if (log == null) {
            return R.failed("日志不存在");
        }
        return R.ok(log);
    }

    @Operation(summary = "分页查询日志", description = "根据条件分页查询日志列表")
    @PostMapping("/page")
    public R<Page<SystemLogPageVO>> queryLogPage(@Valid @RequestBody SystemLogQueryDTO queryDTO) {
        Page<SystemLogPageVO> page = umpSystemLogService.queryLogPage(queryDTO);
        return R.ok(page);
    }

    @Operation(summary = "根据日志类型查询日志列表", description = "根据日志类型查询日志列表")
    @GetMapping("/type/{logType}")
    public R<List<SystemLogDetailVO>> getByLogType(
            @Parameter(description = "日志类型", required = true) 
            @PathVariable String logType,
            @RequestParam(required = false) Integer limit) {
        List<SystemLogDetailVO> logs = umpSystemLogService.getByLogType(logType, limit);
        return R.ok(logs);
    }

    @Operation(summary = "根据日志级别查询日志列表", description = "根据日志级别查询日志列表")
    @GetMapping("/level/{logLevel}")
    public R<List<SystemLogDetailVO>> getByLogLevel(
            @Parameter(description = "日志级别", required = true) 
            @PathVariable String logLevel,
            @RequestParam(required = false) Integer limit) {
        List<SystemLogDetailVO> logs = umpSystemLogService.getByLogLevel(logLevel, limit);
        return R.ok(logs);
    }

    @Operation(summary = "根据应用标识查询日志列表", description = "根据应用标识查询日志列表")
    @GetMapping("/app/{appKey}")
    public R<List<SystemLogDetailVO>> getByAppKey(
            @Parameter(description = "应用标识", required = true) 
            @PathVariable String appKey,
            @RequestParam(required = false) Integer limit) {
        List<SystemLogDetailVO> logs = umpSystemLogService.getByAppKey(appKey, limit);
        return R.ok(logs);
    }

    @Operation(summary = "根据操作者查询日志列表", description = "根据操作者查询日志列表")
    @GetMapping("/operator/{operator}")
    public R<List<SystemLogDetailVO>> getByOperator(
            @Parameter(description = "操作者", required = true) 
            @PathVariable String operator,
            @RequestParam(required = false) Integer limit) {
        List<SystemLogDetailVO> logs = umpSystemLogService.getByOperator(operator, limit);
        return R.ok(logs);
    }

    @Operation(summary = "获取日志统计信息", description = "获取日志的统计信息")
    @GetMapping("/statistics")
    public R<SystemLogStatisticsVO> getLogStatistics(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(required = false) String logType,
            @RequestParam(required = false) String appKey) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        SystemLogStatisticsVO statistics = umpSystemLogService.getLogStatistics(start, end, logType, appKey);
        return R.ok(statistics);
    }

    @Operation(summary = "获取错误日志统计", description = "获取错误日志的统计信息")
    @GetMapping("/statistics/error")
    public R<List<ErrorLogStatisticsVO>> getErrorLogStatistics(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        List<ErrorLogStatisticsVO> statistics = umpSystemLogService.getErrorLogStatistics(start, end);
        return R.ok(statistics);
    }

    @Operation(summary = "获取性能统计信息", description = "获取性能统计信息")
    @GetMapping("/statistics/performance")
    public R<LogPerformanceStatisticsVO> getPerformanceStatistics(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        LogPerformanceStatisticsVO statistics = umpSystemLogService.getPerformanceStatistics(start, end);
        return R.ok(statistics);
    }

    @Operation(summary = "获取API调用统计", description = "获取API调用统计")
    @GetMapping("/statistics/api")
    public R<List<ApiCallStatisticsVO>> getApiCallStatistics(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(required = false) Integer limit) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        List<ApiCallStatisticsVO> statistics = umpSystemLogService.getApiCallStatistics(start, end, limit);
        return R.ok(statistics);
    }

    @Operation(summary = "获取操作者统计", description = "获取操作者统计")
    @GetMapping("/statistics/operator")
    public R<List<OperatorStatisticsVO>> getOperatorStatistics(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(required = false) Integer limit) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        List<OperatorStatisticsVO> statistics = umpSystemLogService.getOperatorStatistics(start, end, limit);
        return R.ok(statistics);
    }

    @Operation(summary = "获取应用统计", description = "获取应用统计")
    @GetMapping("/statistics/app")
    public R<List<AppStatisticsVO>> getAppStatistics(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(required = false) Integer limit) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        List<AppStatisticsVO> statistics = umpSystemLogService.getAppStatistics(start, end, limit);
        return R.ok(statistics);
    }

    @Operation(summary = "清理过期日志", description = "清理指定天数前的过期日志")
    @DeleteMapping("/clean/expired")
    public R<Integer> cleanExpiredLogs(
            @RequestParam(defaultValue = "30") Integer days) {
        int cleanedCount = umpSystemLogService.cleanExpiredLogs(days);
        String ret = "成功清理" + String.valueOf(cleanedCount) + "条过期日志";
        return R.ok(cleanedCount, ret);
    }

    @Operation(summary = "批量删除日志", description = "批量删除日志")
    @DeleteMapping("/batch")
    public R<Integer> batchDeleteLogs(@RequestBody List<String> ids) {
        int deletedCount = umpSystemLogService.batchDeleteLogs(ids);
        String ret = "成功删除" + String.valueOf(deletedCount) + "条日志";
        return R.ok(deletedCount, ret);
    }

    @Operation(summary = "获取日志趋势统计", description = "获取日志趋势统计")
    @GetMapping("/statistics/trend")
    public R<List<LogTrendVO>> getLogTrendStatistics(
            @RequestParam String startTime,
            @RequestParam String endTime,
            @RequestParam(defaultValue = "DAY") String interval,
            @RequestParam(required = false) String logType,
            @RequestParam(required = false) String logLevel) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        List<LogTrendVO> trend = umpSystemLogService.getLogTrendStatistics(start, end, interval, logType, logLevel);
        return R.ok(trend);
    }

    @Operation(summary = "获取错误日志详情", description = "获取错误日志详情列表")
    @GetMapping("/error")
    public R<List<SystemLogDetailVO>> getErrorLogs(
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(required = false) Integer limit) {
        LocalDateTime start = parseDateTime(startTime);
        LocalDateTime end = parseDateTime(endTime);
        
        List<SystemLogDetailVO> errorLogs = umpSystemLogService.getErrorLogs(start, end, limit);
        return R.ok(errorLogs);
    }

    @Operation(summary = "搜索日志", description = "根据关键词搜索日志")
    @GetMapping("/search")
    public R<List<SystemLogDetailVO>> searchLogs(
            @RequestParam String keyword,
            @RequestParam(required = false) Integer limit) {
        List<SystemLogDetailVO> logs = umpSystemLogService.searchLogs(keyword, limit);
        return R.ok(logs);
    }

    @Operation(summary = "导出日志", description = "导出日志数据")
    @PostMapping("/export")
    public void exportLogs(@Valid @RequestBody SystemLogQueryDTO queryDTO,
                          HttpServletResponse response) {
        try {
            List<SystemLogDetailVO> logs = umpSystemLogService.exportLogs(queryDTO);
            
            // 构建CSV内容
            StringBuilder csvContent = new StringBuilder();
            csvContent.append("日志ID,日志类型,日志级别,应用标识,操作者,操作名称,请求ID,API路径,HTTP方法,IP地址,响应代码,响应消息,错误信息,耗时(ms),创建时间\n");
            
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
            for (SystemLogDetailVO log : logs) {
                csvContent.append(log.getId()).append(",");
                csvContent.append(log.getLogType()).append(",");
                csvContent.append(log.getLogLevel()).append(",");
                csvContent.append(log.getAppKey() != null ? log.getAppKey() : "").append(",");
                csvContent.append(log.getOperator() != null ? log.getOperator() : "").append(",");
                csvContent.append(log.getOperation() != null ? log.getOperation() : "").append(",");
                csvContent.append(log.getRequestId() != null ? log.getRequestId() : "").append(",");
                csvContent.append(log.getApiPath() != null ? log.getApiPath() : "").append(",");
                csvContent.append(log.getHttpMethod() != null ? log.getHttpMethod() : "").append(",");
                csvContent.append(log.getIpAddress() != null ? log.getIpAddress() : "").append(",");
                csvContent.append(log.getResponseCode() != null ? log.getResponseCode() : "").append(",");
                csvContent.append(log.getResponseMessage() != null ? log.getResponseMessage() : "").append(",");
                csvContent.append(log.getErrorMessage() != null ? log.getErrorMessage() : "").append(",");
                csvContent.append(log.getCostTime() != null ? log.getCostTime() : "").append(",");
                csvContent.append(log.getCreateTime() != null ? log.getCreateTime().format(formatter) : "").append("\n");
            }
            
            // 设置响应头
            String filename = "system_logs_" + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss")) + ".csv";
            response.setContentType("text/csv");
            response.setCharacterEncoding(StandardCharsets.UTF_8.name());
            response.setHeader(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + filename + "\"");
            
            // 写入响应
            response.getWriter().write(csvContent.toString());
            response.getWriter().flush();
            
            log.info("日志导出成功，共导出{}条日志", logs.size());
        } catch (IOException e) {
            log.error("导出日志失败", e);
            throw new RuntimeException("导出日志失败", e);
        }
    }

    private LocalDateTime parseDateTime(String dateTimeStr) {
        if (!StringUtils.hasText(dateTimeStr)) {
            return null;
        }
        
        try {
            return LocalDateTime.parse(dateTimeStr, DateTimeFormatter.ISO_LOCAL_DATE_TIME);
        } catch (Exception e) {
            try {
                return LocalDateTime.parse(dateTimeStr + "T00:00:00", DateTimeFormatter.ISO_LOCAL_DATE_TIME);
            } catch (Exception e2) {
                log.warn("解析时间字符串失败: {}", dateTimeStr, e2);
                return null;
            }
        }
    }
}