<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="work.metanet.feng.admin.mapper.PrmSocialRelationshipMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="work.metanet.feng.admin.api.entity.PrmSocialRelationship">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="contact_a" property="contactA" jdbcType="INTEGER"/>
        <result column="contact_b" property="contactB" jdbcType="INTEGER"/>
        <result column="relationship_type" property="relationshipType" jdbcType="VARCHAR"/>
        <result column="bi_directional" property="biDirectional" jdbcType="CHAR"/>
        <result column="intimacy_score" property="intimacyScore" jdbcType="DECIMAL"/>
        <result column="contact_time" property="contactTime" jdbcType="TIMESTAMP"/>
        <result column="contact_frequency" property="contactFrequency" jdbcType="INTEGER"/>
        <result column="interaction_history" property="interactionHistory" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="organ_code" property="organCode" jdbcType="VARCHAR"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_by" property="updateBy" jdbcType="VARCHAR"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="del_flag" property="delFlag" jdbcType="CHAR"/>
    </resultMap>

    <!-- SocialRelationshipVO结果映射 -->
    <resultMap id="SocialRelationshipVOResultMap" type="work.metanet.feng.admin.api.vo.SocialRelationshipVO">
        <id column="id" property="id"/>
        <result column="contact_a" property="contactA"/>
        <result column="contact_b" property="contactB"/>
        <result column="relationship_type" property="relationshipType" jdbcType="VARCHAR"/>
        <result column="bi_directional" property="biDirectional" jdbcType="CHAR"/>
        <result column="intimacy_score" property="intimacyScore"/>
        <result column="contact_time" property="contactTime"/>
        <result column="contact_frequency" property="contactFrequency" jdbcType="INTEGER"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <!-- 关联查询联系人信息 -->
        <association property="contactAInfo" column="contact_a" 
                     select="work.metanet.feng.admin.mapper.PrmContactMapper.selectContactDetail"/>
        <association property="contactBInfo" column="contact_b" 
                     select="work.metanet.feng.admin.mapper.PrmContactMapper.selectContactDetail"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        id, contact_a, contact_b, relationship_type, bi_directional, 
        intimacy_score, contact_time, contact_frequency, interaction_history, 
        remark, organ_code, create_by, create_time, update_by, update_time, del_flag
    </sql>

    <!-- 分页查询关系列表 -->
    <select id="pageRelationship" resultMap="SocialRelationshipVOResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM prm_social_relationship
        <where>
            del_flag = '0'
            <if test="vo.contactA != null">
                AND contact_a = #{vo.contactA}
            </if>
            <if test="vo.contactB != null">
                AND contact_b = #{vo.contactB}
            </if>
            <if test="vo.relationshipType != null and vo.relationshipType != ''">
                AND relationship_type = #{vo.relationshipType}
            </if>
        </where>
        ORDER BY contact_time DESC
    </select>

    <!-- 获取关系详情 -->
    <select id="getRelationshipDetail" resultMap="SocialRelationshipVOResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM prm_social_relationship
        WHERE id = #{id} AND del_flag = '0'
    </select>

    <!-- 查询可见的关系网络 -->
    <select id="selectVisibleRelationships" resultMap="BaseResultMap">
        SELECT r.* 
        FROM prm_social_relationship r
        LEFT JOIN prm_contact c1 ON r.contact_a = c1.id
        LEFT JOIN prm_contact c2 ON r.contact_b = c2.id
        WHERE r.del_flag = '0'
        <if test="accessibleCustomerIds != null and !accessibleCustomerIds.isEmpty()">
            AND (
                c1.customer_id IN 
                <foreach collection="accessibleCustomerIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
                OR c2.customer_id IN 
                <foreach collection="accessibleCustomerIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
                <if test="includeDiscrete">
                    OR (c1.customer_id IS NULL AND c2.customer_id IS NULL)
                </if>
            )
        </if>
        ORDER BY r.contact_time DESC
    </select>

    <!-- 根据联系人列表查询关系 -->
    <select id="getRelationsByContacts" resultMap="SocialRelationshipVOResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM prm_social_relationship
        WHERE del_flag = '0'
        AND (contact_a IN 
            <foreach collection="contactIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        OR contact_b IN 
            <foreach collection="contactIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>)
        ORDER BY contact_time DESC
    </select>

    <!-- 获取联系人参与的所有关系 -->
    <select id="getContactRelations" resultMap="BaseResultMap">
        SELECT *
        FROM prm_social_relationship
        WHERE (contact_a = #{contactId} OR contact_b = #{contactId})
        AND del_flag = '0'
    </select>

    <!-- 获取两个联系人之间的直接关系 -->
    <select id="getRelationshipBetweenContacts" resultMap="SocialRelationshipVOResultMap">
        SELECT r.* 
        FROM prm_social_relationship r
        WHERE ((r.contact_a = #{contactA} AND r.contact_b = #{contactB})
              OR (r.contact_a = #{contactB} AND r.contact_b = #{contactA}))
        AND r.del_flag = '0'
        LIMIT 1
    </select>
</mapper>